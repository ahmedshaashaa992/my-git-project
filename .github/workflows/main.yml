name: Deploy Frontend to GitHub Pages

on:
  push:
    branches: ['main']
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      # 1. Checkout entire repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Verify lockfile exists
      - name: Check for lockfile
        id: check-lockfile
        run: |
          cd frontend
          if [ -f package-lock.json ]; then
            echo "lockfile=package-lock.json" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "lockfile=yarn.lock" >> $GITHUB_OUTPUT
          else
            echo "No lockfile found!" >&2
            exit 1
          fi

      # 3. Setup Node with cache
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      # 4. Install dependencies
      - name: Install dependencies
        working-directory: ./frontend
        run: |
          if [ "${{ steps.check-lockfile.outputs.lockfile }}" == "package-lock.json" ]; then
            npm ci
          else
            yarn install --frozen-lockfile
          fi

      # 5. Build with path fixes
      - name: Build
        working-directory: ./frontend
        run: |
          npm run build
          sed -i 's|/assets/|./assets/|g' dist/index.html
          cp dist/index.html dist/404.html
          echo "Build contents:"
          ls -R dist

      # 6. Deploy to Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'frontend/dist'

      - name: Deploy
        uses: actions/deploy-pages@v4